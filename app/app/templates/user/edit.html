<!-- app/templates/user/edit.html -->
{% extends "base.html" %} {% block content %}
<h2>Edit User: {{ user.name }}</h2>

{% with messages = get_flashed_messages(with_categories=true) %} {% if messages %} {% for category, message in messages %}
<div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %} {% endif %} {% endwith %}

<form method="POST">
    {{ form.hidden_tag() }}

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">First Name</label> {{ form.first_name(class="form-control") }} {% if form.first_name.errors %}
            <div class="text-danger small">
                {% for error in form.first_name.errors %} {{ error }}<br> {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Last Name</label> {{ form.last_name(class="form-control") }} {% if form.last_name.errors %}
            <div class="text-danger small">
                {% for error in form.last_name.errors %} {{ error }}<br> {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Username</label> {{ form.username(class="form-control") }} {% if form.username.errors %}
            <div class="text-danger small">
                {% for error in form.username.errors %} {{ error }}<br> {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Mobile</label> {{ form.mobile(class="form-control") }} {% if form.mobile.errors %}
            <div class="text-danger small">
                {% for error in form.mobile.errors %} {{ error }}<br> {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">New Password</label> {{ form.password(class="form-control", placeholder="Leave empty to keep current password") }} {% if form.password.errors %}
            <div class="text-danger small">
                {% for error in form.password.errors %} {{ error }}<br> {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">Organization</label> {{ form.organization(class="form-control", id="organization") }}
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">Area</label> {{ form.area(class="form-control", id="area") }}
        </div>

        <div class="col-md-4 mb-3">
            <label class="form-label">Position</label> {{ form.position(class="form-control") }}
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Update User</button>
    <a href="{{ url_for('user.list') }}" class="btn btn-secondary">Cancel</a>
</form>

<script>
    // AJAX برای بارگذاری نواحی
    document.getElementById('organization').addEventListener('change', function() {
        const orgId = this.value;
        const areaSelect = document.getElementById('area');
        if (orgId == 0) {
            areaSelect.innerHTML = '<option value="0">First select organization</option>';
            return;
        }
        fetch(`/user/areas/${orgId}`)
            .then(r => r.json())
            .then(data => {
                areaSelect.innerHTML = '<option value="0">--- Select Area ---</option>';
                data.forEach(a => {
                    areaSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`;
                });
            });
    });
</script>
{% endblock %}