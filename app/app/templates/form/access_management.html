{% extends "base.html" %} {% block content %}
<div class="container">
    <div id="form-data" data-form-id="{{ form.id }}" style="display: none;"></div>
    <h2>ğŸ” Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ±Ù…: {{ form.title }}</h2>

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#roleAccess">Ø¯Ø³ØªØ±Ø³ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ (Ù†Ù‚Ø´â€ŒÙ‡Ø§)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#userAccess">Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ±Ø¯ÛŒ (Ú©Ø§Ø±Ø¨Ø±Ø§Ù†)</a>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content">
                <!-- Ø¯Ø³ØªØ±Ø³ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ -->
                <div class="tab-pane fade show active" id="roleAccess">
                    <h5>ØªØ¹ÛŒÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Ù†Ù‚Ø´</th>
                                    <th>Ù…Ø´Ø§Ù‡Ø¯Ù‡</th>
                                    <th>Ù¾Ø± Ú©Ø±Ø¯Ù†</th>
                                    <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
                                    <th>Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for role in roles %}
                                <tr>
                                    <td>{{ role.name }}</td>
                                    <td><input type="checkbox" class="role-permission" data-role="{{ role.id }}" value="view"></td>
                                    <td><input type="checkbox" class="role-permission" data-role="{{ role.id }}" value="fill"></td>
                                    <td><input type="checkbox" class="role-permission" data-role="{{ role.id }}" value="edit"></td>
                                    <td><input type="checkbox" class="role-permission-full" data-role="{{ role.id }}"></td>
                                    <td>
                                        <button class="btn btn-sm btn-success save-role-access" data-role="{{ role.id }}">Ø°Ø®ÛŒØ±Ù‡</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ±Ø¯ÛŒ -->
                <div class="tab-pane fade" id="userAccess">
                    <h5>ØªØ¹ÛŒÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø®Ø§Øµ</h5>
                    <div class="mb-3">
                        <select class="form-select" id="userSelect">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.name }} ({{ user.username }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="userPermissions" style="display: none;">
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-check-label">
                                    <input type="checkbox" class="user-permission" value="view"> Ù…Ø´Ø§Ù‡Ø¯Ù‡
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-check-label">
                                    <input type="checkbox" class="user-permission" value="fill"> Ù¾Ø± Ú©Ø±Ø¯Ù†
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-check-label">
                                    <input type="checkbox" class="user-permission" value="edit"> ÙˆÛŒØ±Ø§ÛŒØ´
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-check-label">
                                    <input type="checkbox" class="user-permission-full"> Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-success" id="saveUserAccess">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="/form/list" class="btn btn-secondary">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ÙØ±Ù…â€ŒÙ‡Ø§</a>
    </div>
</div>

<script>
    // JavaScript Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
    /*document.addEventListener('DOMContentLoaded', function() {
        const formId = {
            {
                form.id
            }
        };

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ù‚Ø´
        document.querySelectorAll('.save-role-access').forEach(btn => {
            btn.addEventListener('click', function() {
                const roleId = this.dataset.role;
                const permissions = [];

                // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ permissions Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                document.querySelectorAll('.role-permission[data-role="' + roleId + '"]:checked').forEach(cb => {
                    permissions.push(cb.value);
                });

                // Ø§Ú¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                if (document.querySelector('.role-permission-full[data-role="' + roleId + '"]:checked')) {
                    permissions.push('full');
                }

                console.log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', {
                    formId,
                    roleId,
                    permissions
                });

                // Ø§ÛŒØ¬Ø§Ø¯ FormData Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
                const formData = new FormData();
                formData.append('form_id', formId);
                formData.append('access_type', 'role');
                formData.append('target_id', roleId);
                permissions.forEach(perm => {
                    formData.append('permissions', perm);
                });

                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                fetch('/form/access/save', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.json())
                    .then(data => {
                        console.log('Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', data);
                        if (data.success) {
                            alert('âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                        } else {
                            alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ');
                        }
                    })
                    .catch(error => {
                        console.error('Ø®Ø·Ø§:', error);
                        alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡');
                    });
            });
        });

        // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        document.getElementById('userSelect').addEventListener('change', function() {
            document.getElementById('userPermissions').style.display = this.value ? 'block' : 'none';
        });

        // Ù…Ù†Ø·Ù‚ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„
        document.querySelectorAll('.role-permission-full').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const roleId = this.dataset.role;
                const otherCheckboxes = document.querySelectorAll('.role-permission[data-role="' + roleId + '"]');

                if (this.checked) {
                    otherCheckboxes.forEach(cb => {
                        cb.checked = true;
                        cb.disabled = true;
                    });
                } else {
                    otherCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });
        });
    });*/

    document.addEventListener('DOMContentLoaded', function() {
        console.log('âœ… JavaScript Ù„ÙˆØ¯ Ø´Ø¯');

        // Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² data attribute
        var formDataElement = document.getElementById('form-data');
        var formId = formDataElement ? formDataElement.getAttribute('data-form-id') : null;
        console.log('ğŸ” ÙØ±Ù… ID:', formId);

        if (!formId) {
            console.error('âŒ formId Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
            return;
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ù‚Ø´
        var saveButtons = document.querySelectorAll('.save-role-access');
        for (var i = 0; i < saveButtons.length; i++) {
            saveButtons[i].addEventListener('click', function() {
                var roleId = this.getAttribute('data-role');
                console.log('ğŸ” Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´:', roleId);

                var permissions = [];

                // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ permissions
                var checkboxes = document.querySelectorAll('.role-permission[data-role="' + roleId + '"]:checked');
                for (var j = 0; j < checkboxes.length; j++) {
                    permissions.push(checkboxes[j].value);
                    console.log('âœ… permission Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', checkboxes[j].value);
                }

                var fullAccess = document.querySelector('.role-permission-full[data-role="' + roleId + '"]:checked');
                if (fullAccess) {
                    permissions.push('full');
                    console.log('âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯');
                }

                console.log('ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', {
                    formId: formId,
                    roleId: roleId,
                    permissions: permissions
                });

                if (permissions.length === 0) {
                    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    return;
                }

                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                var formData = new FormData();
                formData.append('form_id', formId);
                formData.append('access_type', 'role');
                formData.append('target_id', roleId);
                for (var k = 0; k < permissions.length; k++) {
                    formData.append('permissions', permissions[k]);
                }

                console.log('ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ±...');

                fetch('/form/access/save', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) {
                        console.log('ğŸ“¥ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®:', response.status);
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('ğŸ“¦ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', data);
                        if (data.success) {
                            alert('âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                        } else {
                            alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ: ' + (data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
                        }
                    })
                    .catch(function(error) {
                        console.error('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:', error);
                        alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
                    });
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        var userSelect = document.getElementById('userSelect');
        if (userSelect) {
            userSelect.addEventListener('change', function() {
                var userPermissions = document.getElementById('userPermissions');
                if (userPermissions) {
                    userPermissions.style.display = this.value ? 'block' : 'none';
                }
            });
        }

        console.log('âœ… Ù‡Ù…Ù‡ event listenerÙ‡Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù†Ø¯');
    });
</script>

{% endblock %}