{% extends "base.html" %} {% block content %}
<h2>๐ ุงุฌุงุฏ ูุฑู ุฌุฏุฏ (ูพุดุฑูุชู)</h2>

<div class="card">
    <div class="card-body">
        <form id="formBuilder">
            <div class="mb-3">
                <label class="form-label">ุนููุงู ูุฑู</label>
                <input type="text" name="title" class="form-control" required>
            </div>

            <h4>๐๏ธ ุณุงุฎุชุงุฑ ุณุชููโูุง</h4>
            <div id="columns-container">
                <div class="column-item border p-3 mb-3 rounded">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" name="column_name" placeholder="ูุงู ุณุชูู" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <select name="column_type" class="form-control" onchange="toggleOptions(this)">
                                <option value="text">ูุชู</option>
                                <option value="number">ุนุฏุฏ</option>
                                <option value="date">ุชุงุฑุฎ</option>
                                <option value="select">ูุณุช ฺฉุดู</option>
                                <option value="radio">ุฑุงุฏู ุจุงุชู</option>
                                <option value="checkbox">ุชฺฉ</option>
                            </select>
                        </div>
                        <div class="col-md-3 options-container" style="display: none;">
                            <input type="text" name="column_options" placeholder="ฺฏุฒููโูุง (ุจุง ฺฉุงูุง ุฌุฏุง ฺฉูุฏ)" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <select name="editable_by_user" class="form-control">
                                <option value="true">ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ูพุฑ ฺฉูุฏ</option>
                                <option value="false">ููุท ุงุฌุงุฏฺฉููุฏู</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="required">
                                <label class="form-check-label">ุงูุฒุงู</label>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger" onclick="removeColumn(this)">๐๏ธ</button>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-info mb-3" onclick="addColumn()">โ ุงูุฒูุฏู ุณุชูู</button>
            <br>
            <button type="submit" class="btn btn-success">๐ฆ ุงุฌุงุฏ ูุฑู</button>
        </form>
    </div>
</div>

<script>
    function toggleOptions(select) {
        const type = select.value;
        const optionsContainer = select.closest('.row').querySelector('.options-container');
        optionsContainer.style.display = (type === 'select' || type === 'radio') ? 'block' : 'none';
    }

    function addColumn() {
        const container = document.getElementById('columns-container');
        const newColumn = container.firstElementChild.cloneNode(true);

        // ูพุงฺฉ ฺฉุฑุฏู ููุงุฏุฑ
        newColumn.querySelectorAll('input').forEach(input => {
            if (input.type !== 'checkbox') input.value = '';
            else input.checked = false;
        });

        container.appendChild(newColumn);
    }

    function removeColumn(button) {
        if (document.querySelectorAll('.column-item').length > 1) {
            button.closest('.column-item').remove();
        }
    }

    document.getElementById('formBuilder').onsubmit = function(e) {
        e.preventDefault();

        const title = document.querySelector('[name="title"]').value;
        const columns = [];

        document.querySelectorAll('.column-item').forEach(columnEl => {
            const column = {
                name: columnEl.querySelector('[name="column_name"]').value,
                type: columnEl.querySelector('[name="column_type"]').value,
                editable_by_user: columnEl.querySelector('[name="editable_by_user"]').value === 'true',
                required: columnEl.querySelector('[name="required"]').checked
            };

            // ุงุถุงูู ฺฉุฑุฏู ฺฏุฒููโูุง ุจุฑุง select ู radio
            if (column.type === 'select' || column.type === 'radio') {
                const optionsText = columnEl.querySelector('[name="column_options"]').value;
                column.options = optionsText.split(',').map(opt => opt.trim()).filter(opt => opt);
            }

            columns.push(column);
        });

        const structure = JSON.stringify({
            columns
        });

        // ุงุฑุณุงู ุจู ุณุฑูุฑ
        fetch('/form/create_advanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(title)}&structure=${encodeURIComponent(structure)}`
        }).then(response => {
            if (response.ok) {
                window.location.href = '/form/list';
            }
        });
    };
</script>
{% endblock %}