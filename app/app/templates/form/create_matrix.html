{% extends "base.html" %} {% block content %}
<h2>ğŸ“‹ Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù… Ø¬Ø¯ÛŒØ¯ (Ø¬Ø¯ÙˆÙ„ÛŒ)</h2>

<div class="card">
    <div class="card-body" style="background-color: #f1f1f1;">
        <form id="matrixFormBuilder">
            <!-- CSRF Token-->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÙˆÙ„ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">Ø¹Ù†ÙˆØ§Ù† ÙØ±Ù…</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">ØªØ¹Ø¯Ø§Ø¯ Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</label>
                    <input type="number" name="rows" class="form-control" min="1" max="20" value="3" onchange="generateMatrix()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ØªØ¹Ø¯Ø§Ø¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§</label>
                    <input type="number" name="columns" class="form-control" min="1" max="10" value="3" onchange="generateMatrix()">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary w-100" onclick="generateMatrix()">Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„</button>
                </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ù¾ÙˆÛŒØ§ -->
            <div id="matrix-container" class="mb-4">
                <p class="text-muted">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªØ¹Ø¯Ø§Ø¯ Ø³Ø·Ø± Ùˆ Ø³ØªÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± -->
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-success" onclick="addNewRow()">
                    â• Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø·Ø± Ø¬Ø¯ÛŒØ¯
                </button>
                <button type="submit" class="btn btn-primary">Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù…</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentRows = 0;
    let currentCols = 0;

    function generateMatrix() {
        const rows = parseInt(document.querySelector('[name="rows"]').value);
        const cols = parseInt(document.querySelector('[name="columns"]').value);
        const container = document.getElementById('matrix-container');

        if (rows < 1 || cols < 1) return;

        currentRows = rows;
        currentCols = cols;

        let tableHTML = `
            <h5>Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÙˆÙ„</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
        `;

        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø¯Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
        for (let c = 0; c < cols; c++) {
            tableHTML += `
                <th>
                    <input type="text" class="form-control form-control-sm" 
                           name="col_${c}_name" placeholder="Ù†Ø§Ù… Ø³ØªÙˆÙ† ${c+1}" required>
                    <select class="form-select form-select-sm mt-1" name="col_${c}_type" onchange="toggleColumnSettings(${c})">
                        <option value="text">Ù…ØªÙ†</option>
                        <option value="number">Ø¹Ø¯Ø¯</option>
                        <option value="date">ØªØ§Ø±ÛŒØ®</option>
                        <option value="select">Ù„ÛŒØ³Øª Ú©Ø´ÙˆÛŒÛŒ</option>
                        <option value="radio">Ø±Ø§Ø¯ÛŒÙˆ Ø¨Ø§ØªÙ†</option>
                        <option value="checkbox">ØªÛŒÚ©</option>
                    </select>
                    
                    <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø®ØµÙˆØµ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ -->
                    <div class="checkbox-setting mt-1" id="checkbox_${c}" style="display: none;">
                        <input type="text" class="form-control form-control-sm" 
                               name="col_${c}_checkbox_label" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú†Ú©â€ŒØ¨Ø§Ú©Ø³" value="ØªØ§ÛŒÛŒØ¯"
                               onchange="updateColumnCells(${c})">
                    </div>
                    
                    <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø®ØµÙˆØµ select Ùˆ radio -->
                    <div class="options-setting mt-1" id="options_${c}" style="display: none;">
                        <input type="text" class="form-control form-control-sm" 
                               name="col_${c}_options" placeholder="Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)" 
                               onchange="updateColumnCells(${c})">
                    </div>
                    
                    <select class="form-select form-select-sm mt-1" name="col_${c}_editable">
                        <option value="true">Ú©Ø§Ø±Ø¨Ø± Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯</option>
                        <option value="false">ÙÙ‚Ø· Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡</option>
                    </select>
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" name="col_${c}_required">
                        <label class="form-check-label">Ø§Ù„Ø²Ø§Ù…ÛŒ</label>
                    </div>
                </th>
            `;
        }

        tableHTML += `<th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="tableBody">`;

        // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        for (let r = 0; r < rows; r++) {
            tableHTML += generateRowHTML(r, cols);
        }

        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    // Ø§ÛŒØ¬Ø§Ø¯ HTML ÛŒÚ© Ø³Ø·Ø±
    function generateRowHTML(rowIndex, cols) {
        let rowHTML = `<tr id="row_${rowIndex}"><td class="align-middle">${rowIndex + 1}</td>`;

        for (let c = 0; c < cols; c++) {
            rowHTML += `
                <td id="cell_${rowIndex}_${c}">
                    <input type="text" class="form-control form-control-sm cell-input" 
                           name="cell_${rowIndex}_${c}" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶" data-col="${c}">
                </td>
            `;
        }

        rowHTML += `
            <td class="align-middle">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(${rowIndex})" ${rowIndex === 0 ? 'disabled' : ''}>
                    Ø­Ø°Ù
                </button>
            </td>
        </tr>`;

        return rowHTML;
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± Ø¬Ø¯ÛŒØ¯
    function addNewRow() {
        if (currentCols === 0) {
            alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯!');
            return;
        }

        const tbody = document.getElementById('tableBody');
        const newRowIndex = currentRows;

        tbody.innerHTML += generateRowHTML(newRowIndex, currentCols);
        currentRows++;

        // Ø¢Ù¾Ø¯ÛŒØª ØªÙ…Ø§Ù… Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø³ØªÙˆÙ†
        for (let c = 0; c < currentCols; c++) {
            const cell = document.getElementById(`cell_${newRowIndex}_${c}`);
            const type = document.querySelector(`[name="col_${c}_type"]`).value;
            updateCellInput(cell, type, c);
        }

        updateRowNumbers();
    }

    // Ø­Ø°Ù Ø³Ø·Ø±
    function removeRow(rowIndex) {
        const row = document.getElementById(`row_${rowIndex}`);
        if (row && currentRows > 1) {
            row.remove();
            currentRows--;
            updateRowNumbers();
        }
    }

    // Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ù‡ Ø³Ø·Ø±Ù‡Ø§
    function updateRowNumbers() {
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach((row, index) => {
            const firstCell = row.cells[0];
            const deleteButton = row.querySelector('button');

            if (firstCell) {
                firstCell.textContent = index + 1;
            }

            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø¨Ø±Ø§ÛŒ Ø³Ø·Ø± Ø§ÙˆÙ„
            if (deleteButton) {
                deleteButton.disabled = index === 0;
            }
        });
    }

    function toggleColumnSettings(colIndex) {
        const type = document.querySelector(`[name="col_${colIndex}_type"]`).value;

        document.getElementById(`options_${colIndex}`).style.display =
            (type === 'select' || type === 'radio') ? 'block' : 'none';

        document.getElementById(`checkbox_${colIndex}`).style.display =
            (type === 'checkbox') ? 'block' : 'none';

        updateColumnCells(colIndex);
    }

    function updateColumnCells(colIndex) {
        const type = document.querySelector(`[name="col_${colIndex}_type"]`).value;

        for (let r = 0; r < currentRows; r++) {
            const cell = document.getElementById(`cell_${r}_${colIndex}`);
            if (cell) {
                updateCellInput(cell, type, colIndex);
            }
        }
    }

    function updateCellInput(cell, type, colIndex) {
        let inputHTML = '';
        const [_, r, c] = cell.id.split('_');

        switch (type) {
            case 'text':
                inputHTML = `<input type="text" class="form-control form-control-sm cell-input" name="cell_${r}_${c}" placeholder="Ù…ØªÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" data-col="${c}">`;
                break;

            case 'number':
                inputHTML = `<input type="number" class="form-control form-control-sm cell-input" name="cell_${r}_${c}" placeholder="Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" data-col="${c}">`;
                break;

            case 'date':
                inputHTML = `<input type="date" class="form-control form-control-sm cell-input" name="cell_${r}_${c}" data-col="${c}">`;
                break;

            case 'select':
                const optionsText = document.querySelector(`[name="col_${colIndex}_options"]`).value;
                const options = optionsText.split(',').map(opt => opt.trim()).filter(opt => opt);

                inputHTML = `<select class="form-select form-select-sm cell-input" name="cell_${r}_${c}" data-col="${c}"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>`;
                options.forEach(option => {
                    inputHTML += `<option value="${option}">${option}</option>`;
                });
                inputHTML += `</select>`;
                break;

            case 'radio':
                const radioOptions = document.querySelector(`[name="col_${colIndex}_options"]`).value;
                const radioOptionsList = radioOptions.split(',').map(opt => opt.trim()).filter(opt => opt);

                inputHTML = `<div class="radio-group">`;
                radioOptionsList.forEach((option, index) => {
                    inputHTML += `
                        <div class="form-check">
                            <input class="form-check-input cell-input" type="radio" name="cell_${r}_${c}" value="${option}" id="radio_${r}_${c}_${index}" data-col="${c}">
                            <label class="form-check-label" for="radio_${r}_${c}_${index}">${option}</label>
                        </div>
                    `;
                });
                inputHTML += `</div>`;
                break;

            case 'checkbox':
                const checkboxLabel = document.querySelector(`[name="col_${colIndex}_checkbox_label"]`).value || 'ØªØ§ÛŒÛŒØ¯';
                inputHTML = `
                    <div class="form-check">
                        <input class="form-check-input cell-input" type="checkbox" name="cell_${r}_${c}" value="true" data-col="${c}">
                        <label class="form-check-label">${checkboxLabel}</label>
                    </div>
                `;
                break;
        }

        cell.innerHTML = inputHTML;
    }

    document.getElementById('matrixFormBuilder').onsubmit = function(e) {
        e.preventDefault();

        const title = document.querySelector('[name="title"]').value;
        const cols = currentCols;

        // Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
        const columns = [];
        for (let c = 0; c < cols; c++) {
            const column = {
                name: document.querySelector(`[name="col_${c}_name"]`).value,
                type: document.querySelector(`[name="col_${c}_type"]`).value,
                editable_by_user: document.querySelector(`[name="col_${c}_editable"]`).value === 'true',
                required: document.querySelector(`[name="col_${c}_required"]`).checked
            };

            if (column.type === 'select' || column.type === 'radio') {
                const optionsText = document.querySelector(`[name="col_${c}_options"]`).value;
                column.options = optionsText.split(',').map(opt => opt.trim()).filter(opt => opt);
            }

            if (column.type === 'checkbox') {
                column.checkbox_label = document.querySelector(`[name="col_${c}_checkbox_label"]`).value || 'ØªØ§ÛŒÛŒØ¯';
            }

            columns.push(column);
        }

        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø³Ø·Ø±Ù‡Ø§
        const defaultData = [];
        for (let r = 0; r < currentRows; r++) {
            const row = [];
            for (let c = 0; c < cols; c++) {
                const input = document.querySelector(`[name="cell_${r}_${c}"]`);
                let value = '';

                if (input) {
                    if (input.type === 'checkbox') {
                        value = input.checked ? 'true' : 'false';
                    } else if (input.type === 'radio') {
                        const selectedRadio = document.querySelector(`[name="cell_${r}_${c}"]:checked`);
                        value = selectedRadio ? selectedRadio.value : '';
                    } else {
                        value = input.value;
                    }
                }

                row.push(value);
            }
            defaultData.push(row);
        }

        const structure = JSON.stringify({
            rows: currentRows,
            columns: columns,
            default_data: defaultData
        });

        // ğŸ”¥ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
        console.log("ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:", {
            title,
            structure
        });

        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        fetch('/form/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    title: title,
                    structure: structure
                })
            }).then(response => {
                console.log("ğŸ“¥ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:", response.status);
                if (response.ok) {
                    window.location.href = '/form/list';
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù…! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                }
            })
            .catch(error => {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±!');
            });
    };

    // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§ÙˆÙ„ÛŒÙ‡
    generateMatrix();
</script>

<style>
    .radio-group .form-check {
        margin-bottom: 0.2rem;
    }
    
    .radio-group .form-check-label {
        font-size: 0.8rem;
    }
    
    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}